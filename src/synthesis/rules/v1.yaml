# Phase 2 Synthesis Ruleset v1
# Deterministic rules for deriving AccountPostureState from signals and lifecycle state
#
# Rules are evaluated in priority order (lower priority number = evaluated first)
# First matching rule wins (deterministic, order-stable)
#
# Schema Version: v1
# Ruleset Version: v1.0.0
# Last Updated: 2026-01-23

ruleset:
  version: "v1.0.0"
  schema_version: "v1"
  description: "Deterministic synthesis rules for account posture, risk factors, opportunities, and unknowns"
  
  # Rule evaluation order (priority: lower = evaluated first)
  # Rules are evaluated in priority order (ascending), then by rule_id (alphabetical) as tie-breaker
  # First matching rule wins (deterministic, order-stable)
  # Engine must sort by: (priority, rule_id) to guarantee stable behavior
  #
  # Condition Schema (Normalized):
  # - required_signals: Array of signal conditions (all must match)
  #   - signal_type: Signal type enum
  #   - status: ACTIVE | SUPPRESSED | EXPIRED
  #   - where: Array of property predicates (all must match)
  #     - property: Path to property (e.g., "trend_direction" in signal.context, "createdAt" for time-based comparisons)
  #     - operator: "equals", "greater_than", "less_than", "less_than_or_equal", "within_last_days", "in", "exists", "not_exists"
  #     - value: Comparison value
  #     - Time-based property path: Use "createdAt" (signal.createdAt, ISO timestamp when signal was created)
  #     - Context property path: Use "context.{property_name}" (e.g., "context.trend_direction")
  # - excluded_signals: Array of signal conditions (none must match) - same schema as required_signals
  # - computed_predicates: Array of computed conditions (evaluated by engine, not signal properties)
  #   - name: Predicate name (e.g., "no_engagement_in_days", "has_engagement_in_days")
  #   - params: Parameters for the predicate (e.g., { days: 30 })
  #   - Engine evaluates: no_engagement_in_days = absence of engagement signals in last N days
  #   - Engine evaluates: has_engagement_in_days = presence of engagement signals in last N days
  #   - Engagement signal types (canonical list): FIRST_ENGAGEMENT_OCCURRED, ACCOUNT_ACTIVATION_DETECTED
  #     (Note: NO_ENGAGEMENT_PRESENT is absence-of-evidence, not an engagement signal)
  # - conditions: {} for match-all rules (explicit empty object, not null)
  #
  # Timestamp Handling:
  # - Unknown timestamps (introduced_at, review_after) are NOT in ruleset
  # - Engine stamps them using event.as_of_time (not wall clock)
  # - These fields are excluded from bitwise equality checks
  #
  # TTL Semantics:
  # - output_ttl_days: Posture output expires after N days (re-evaluate)
  # - null = permanent (until inputs change)
  # - Enforcement: If TTL expires and no other rule matches, re-run synthesis
  #
  # Severity Enums (normalized):
  # - risk_factors and opportunities use: "low", "medium", "high" (no "critical" or other values)
  #
  # Evidence Resolution (HARD CONTRACT - IDs-first, types-second):
  # - evidence_signals: Array of signal types (human-readable, for documentation only)
  # - Engine MUST resolve to actual signal_ids when storing in DDB read model
  # - Store as evidence_signal_ids[] (top K) for auditability and traceability
  # - Store as evidence_snapshot_refs[] (S3 URIs + SHA256) for immutable evidence linkage
  # - IDs and snapshot refs are authoritative; types are for human readability only
  # - Violation: If engine stores only types without IDs, synthesis output is invalid
  #
  rules:
    # ============================================================
    # CUSTOMER LIFECYCLE RULES (Highest Priority)
    # ============================================================
    
    # Rule 1: CUSTOMER - Renewal window + support risk → AT_RISK
    - rule_id: "CUSTOMER_RENEWAL_SUPPORT_RISK"
      priority: 1
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
          - signal_type: "SUPPORT_RISK_EMERGING"
            status: "ACTIVE"
      outputs:
        posture: "AT_RISK"
        momentum: "DOWN"
        risk_factors:
          - type: "RENEWAL_RISK"
            severity: "high"
            description: "Renewal window active with emerging support risk"
            evidence_signals:
              - "RENEWAL_WINDOW_ENTERED"
              - "SUPPORT_RISK_EMERGING"
        opportunities: []
        unknowns: []
      output_ttl_days: null  # Permanent until resolved
    
    # Rule 2: CUSTOMER - Renewal window + usage decline → AT_RISK
    - rule_id: "CUSTOMER_RENEWAL_USAGE_DECLINE"
      priority: 2
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
          - signal_type: "USAGE_TREND_CHANGE"
            status: "ACTIVE"
            where:
              - property: "trend_direction"
                operator: "equals"
                value: "DOWN"
      outputs:
        posture: "AT_RISK"
        momentum: "DOWN"
        risk_factors:
          - type: "USAGE_DECLINE"
            severity: "high"
            description: "Usage declining during renewal window"
            evidence_signals:
              - "RENEWAL_WINDOW_ENTERED"
              - "USAGE_TREND_CHANGE"
        opportunities: []
        unknowns: []
      output_ttl_days: null  # Permanent until resolved
    
    # Rule 3: CUSTOMER - Strong usage growth → EXPAND
    - rule_id: "CUSTOMER_USAGE_GROWTH"
      priority: 3
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "USAGE_TREND_CHANGE"
            status: "ACTIVE"
            where:
              - property: "trend_direction"
                operator: "equals"
                value: "UP"
              - property: "trend_magnitude"
                operator: "greater_than"
                value: 0.2  # 20%+ growth
      outputs:
        posture: "EXPAND"
        momentum: "UP"
        risk_factors: []
        opportunities:
          - type: "USAGE_GROWTH"
            severity: "medium"
            description: "Strong usage growth indicates expansion opportunity"
            evidence_signals:
              - "USAGE_TREND_CHANGE"
        unknowns: []
      output_ttl_days: 30  # Re-evaluate monthly
    
    # Rule 4: CUSTOMER - Renewal window + no risks → WATCH
    - rule_id: "CUSTOMER_RENEWAL_WATCH"
      priority: 4
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
        excluded_signals:
          - signal_type: "SUPPORT_RISK_EMERGING"
            status: "ACTIVE"
          - signal_type: "USAGE_TREND_CHANGE"
            status: "ACTIVE"
            where:
              - property: "trend_direction"
                operator: "equals"
                value: "DOWN"
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors: []
        opportunities: []
        unknowns:
          - type: "RENEWAL_INTENT"
            description: "Renewal window active - intent unclear"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 90  # Review after renewal window
    
    # Rule 5: CUSTOMER - Support risk without renewal → WATCH
    - rule_id: "CUSTOMER_SUPPORT_RISK"
      priority: 5
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "SUPPORT_RISK_EMERGING"
            status: "ACTIVE"
        excluded_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
      outputs:
        posture: "WATCH"
        momentum: "DOWN"
        risk_factors:
          - type: "SUPPORT_RISK"
            severity: "medium"
            description: "Support risk emerging outside renewal window"
            evidence_signals:
              - "SUPPORT_RISK_EMERGING"
        opportunities: []
        unknowns: []
      output_ttl_days: 30  # Re-evaluate monthly
    
    # Rule 6: CUSTOMER - Usage decline without renewal → WATCH
    - rule_id: "CUSTOMER_USAGE_DECLINE"
      priority: 6
      lifecycle_state: "CUSTOMER"
      conditions:
        required_signals:
          - signal_type: "USAGE_TREND_CHANGE"
            status: "ACTIVE"
            where:
              - property: "trend_direction"
                operator: "equals"
                value: "DOWN"
        excluded_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
      outputs:
        posture: "WATCH"
        momentum: "DOWN"
        risk_factors:
          - type: "USAGE_DECLINE"
            severity: "medium"
            description: "Usage declining outside renewal window"
            evidence_signals:
              - "USAGE_TREND_CHANGE"
        opportunities: []
        unknowns: []
      output_ttl_days: 30  # Re-evaluate monthly
    
    # Rule 7: CUSTOMER - No active signals → OK
    - rule_id: "CUSTOMER_STABLE"
      priority: 7
      lifecycle_state: "CUSTOMER"
      conditions:
        excluded_signals:
          - signal_type: "RENEWAL_WINDOW_ENTERED"
            status: "ACTIVE"
          - signal_type: "SUPPORT_RISK_EMERGING"
            status: "ACTIVE"
          - signal_type: "USAGE_TREND_CHANGE"
            status: "ACTIVE"
      outputs:
        posture: "OK"
        momentum: "FLAT"
        risk_factors: []
        opportunities: []
        unknowns: []
      output_ttl_days: null  # Stable state (permanent until inputs change)
    
    # ============================================================
    # SUSPECT LIFECYCLE RULES
    # ============================================================
    
    # Rule 8: SUSPECT - Discovery stalled → AT_RISK
    - rule_id: "SUSPECT_DISCOVERY_STALLED"
      priority: 8
      lifecycle_state: "SUSPECT"
      conditions:
        required_signals:
          - signal_type: "DISCOVERY_PROGRESS_STALLED"
            status: "ACTIVE"
      outputs:
        posture: "AT_RISK"
        momentum: "DOWN"
        risk_factors:
          - type: "DISCOVERY_STALL"
            severity: "medium"
            description: "Discovery progress has stalled"
            evidence_signals:
              - "DISCOVERY_PROGRESS_STALLED"
        opportunities: []
        unknowns:
          - type: "STALL_REASON"
            description: "Why has discovery stalled?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 30  # Re-evaluate if stall persists
    
    # Rule 9: SUSPECT - Stakeholder gap → WATCH with risk
    - rule_id: "SUSPECT_STAKEHOLDER_GAP"
      priority: 9
      lifecycle_state: "SUSPECT"
      conditions:
        required_signals:
          - signal_type: "STAKEHOLDER_GAP_DETECTED"
            status: "ACTIVE"
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors:
          - type: "STAKEHOLDER_GAP"
            severity: "medium"
            description: "Missing critical stakeholders in buying group"
            evidence_signals:
              - "STAKEHOLDER_GAP_DETECTED"
        opportunities: []
        unknowns:
          - type: "GAP_RESOLUTION"
            description: "How to engage missing stakeholders?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 60  # Re-evaluate monthly
    
    # Rule 10: SUSPECT - First engagement occurred (within 14 days) → WATCH
    - rule_id: "SUSPECT_FIRST_ENGAGEMENT"
      priority: 10
      lifecycle_state: "SUSPECT"
      conditions:
        required_signals:
          - signal_type: "FIRST_ENGAGEMENT_OCCURRED"
            status: "ACTIVE"
            where:
              # Signal must have occurred within last 14 days (not a stale historical signal)
              # Engine evaluates: signal.createdAt >= (event.as_of_time - 14 days)
              - property: "createdAt"
                operator: "within_last_days"
                value: 14
        excluded_signals:
          - signal_type: "DISCOVERY_PROGRESS_STALLED"
            status: "ACTIVE"
          - signal_type: "STAKEHOLDER_GAP_DETECTED"
            status: "ACTIVE"
      outputs:
        posture: "WATCH"
        momentum: "UP"
        risk_factors: []
        opportunities:
          - type: "EARLY_ENGAGEMENT"
            severity: "low"
            description: "First engagement - opportunity to build momentum"
            evidence_signals:
              - "FIRST_ENGAGEMENT_OCCURRED"
        unknowns:
          - type: "ENGAGEMENT_QUALITY"
            description: "Is this engagement meaningful?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 14  # Re-evaluate after engagement window
    
    # Rule 11: SUSPECT - Default (no specific signals) → WATCH
    - rule_id: "SUSPECT_DEFAULT"
      priority: 11
      lifecycle_state: "SUSPECT"
      conditions: {}  # Matches any SUSPECT state
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors: []
        opportunities: []
        unknowns:
          - type: "SUSPECT_PROGRESSION"
            description: "What will move this account forward?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 30  # Re-evaluate bi-weekly
    
    # ============================================================
    # PROSPECT LIFECYCLE RULES
    # ============================================================
    
    # Rule 12: PROSPECT - Activation + no engagement (computed) → WATCH
    - rule_id: "PROSPECT_ACTIVATION_NO_ENGAGEMENT"
      priority: 12
      lifecycle_state: "PROSPECT"
      conditions:
        required_signals:
          - signal_type: "ACCOUNT_ACTIVATION_DETECTED"
            status: "ACTIVE"
        # No engagement: computed predicate (no engagement signals in last 30 days)
        # Engine evaluates: absence of FIRST_ENGAGEMENT_OCCURRED or any engagement-related signals in last N days
        computed_predicates:
          - name: "no_engagement_in_days"
            params:
              days: 30
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors: []
        opportunities:
          - type: "ACTIVATION_OPPORTUNITY"
            severity: "low"
            description: "Account activated but not yet engaged"
            evidence_signals:
              - "ACCOUNT_ACTIVATION_DETECTED"
        unknowns:
          - type: "ENGAGEMENT_STRATEGY"
            description: "How should we engage this activated account?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 90  # Re-evaluate quarterly
    
    # Rule 13: PROSPECT - Activation only → WATCH
    - rule_id: "PROSPECT_ACTIVATION"
      priority: 13
      lifecycle_state: "PROSPECT"
      conditions:
        required_signals:
          - signal_type: "ACCOUNT_ACTIVATION_DETECTED"
            status: "ACTIVE"
        # Has engagement: computed predicate (engagement signals exist in last 30 days)
        # Engine evaluates: presence of FIRST_ENGAGEMENT_OCCURRED or engagement signals in last N days
        computed_predicates:
          - name: "has_engagement_in_days"
            params:
              days: 30
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors: []
        opportunities:
          - type: "ACTIVATION_OPPORTUNITY"
            severity: "low"
            description: "Account activated"
            evidence_signals:
              - "ACCOUNT_ACTIVATION_DETECTED"
        unknowns: []
      output_ttl_days: 90  # Re-evaluate quarterly
    
    # Rule 14: PROSPECT - Default (no activation) → DORMANT
    - rule_id: "PROSPECT_DORMANT"
      priority: 14
      lifecycle_state: "PROSPECT"
      conditions:
        excluded_signals:
          - signal_type: "ACCOUNT_ACTIVATION_DETECTED"
            status: "ACTIVE"
      outputs:
        posture: "DORMANT"
        momentum: "FLAT"
        risk_factors: []
        opportunities: []
        unknowns:
          - type: "ACTIVATION_TRIGGER"
            description: "What would activate this account?"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 30  # Re-evaluate monthly
    
    # ============================================================
    # CROSS-LIFECYCLE RULES (Lowest Priority - Catch-alls)
    # ============================================================
    
    # Rule 15: Fallback - Any lifecycle, no matching rules → WATCH
    - rule_id: "FALLBACK_WATCH"
      priority: 99
      lifecycle_state: null  # Matches any lifecycle state
      conditions: {}  # Matches if no other rule matched
      outputs:
        posture: "WATCH"
        momentum: "FLAT"
        risk_factors: []
        opportunities: []
        unknowns:
          - type: "STATE_EVALUATION"
            description: "Account state unclear - needs evaluation"
            # Timestamps (introduced_at, review_after) are stamped by engine using event.as_of_time
      output_ttl_days: 7  # Quick re-evaluation

# ============================================================
# Rule Evaluation Metadata
# ============================================================

evaluation:
  # Rule evaluation is deterministic and order-stable
  # Rules are evaluated in priority order (1-99, lower = first)
  # Tie-breaker: If multiple rules have same priority, sort by rule_id (alphabetical)
  # Engine MUST sort by: (priority, rule_id) to guarantee stable behavior
  # First matching rule wins
  # All conditions must match for a rule to apply
  
  # Condition operators:
  # - equals: Exact match
  # - greater_than: Numeric comparison
  # - less_than: Numeric comparison
  # - less_than_or_equal: Numeric comparison
  # - within_last_days: Time-based comparison (signal.createdAt >= event.as_of_time - N days)
  #   - Property path: "createdAt" (signal.createdAt, ISO timestamp when signal was created)
  # - in: Array membership
  # - exists: Property exists
  # - not_exists: Property does not exist
  
  # Computed predicates:
  # - no_engagement_in_days: Absence of engagement signals in last N days
  # - has_engagement_in_days: Presence of engagement signals in last N days
  # - Engine evaluates these by scanning active signals, not by checking signal properties
  # - Engagement signal types (canonical list, locked):
  #   * FIRST_ENGAGEMENT_OCCURRED
  #   * ACCOUNT_ACTIVATION_DETECTED
  #   (Note: NO_ENGAGEMENT_PRESENT is absence-of-evidence, not an engagement signal)
  
  # Signal property access:
  # - signal.context.{property_name} for signal context properties (e.g., "context.trend_direction")
  # - signal.metadata.{property_name} for signal metadata (e.g., "metadata.confidence")
  # - signal.createdAt for time-based comparisons (ISO timestamp when signal was created)
  
  # Unknown TTL semantics:
  # - introduced_at: ISO timestamp when unknown was introduced
  # - expires_at: ISO timestamp when unknown expires (null = never)
  # - review_after: ISO timestamp when unknown should be reviewed (alternative to expires_at)
  
  # Posture state meanings:
  # - OK: Healthy, stable, no action needed
  # - WATCH: Requires attention, monitor closely (may carry risk factors with medium severity)
  # - AT_RISK: Risk factors present, intervention may be needed
  # - EXPAND: Opportunity for growth/expansion
  # - DORMANT: Inactive, no current engagement
  
  # Momentum meanings:
  # - UP: Positive trajectory
  # - FLAT: Stable, no change
  # - DOWN: Negative trajectory (implies "intervention soon" vs just monitoring)
  
  # WATCH + DOWN semantics (normalized):
  # - WATCH posture with DOWN momentum indicates active risk requiring intervention
  # - Risk factors are typically medium severity (not high, which would be AT_RISK)
  # - Examples: CUSTOMER_SUPPORT_RISK (outside renewal), CUSTOMER_USAGE_DECLINE (outside renewal)
  # - Distinction: WATCH + DOWN = "monitor and intervene proactively"; AT_RISK = "intervention required now"
  #
  # TTL Semantics (output_ttl_days):
  # - output_ttl_days: Posture output expires after N days (triggers re-evaluation)
  # - null: Permanent until inputs change (no automatic expiry)
  # - Enforcement: If TTL expires and no other rule matches, synthesis engine re-runs
  # - TTL is evaluated against event.as_of_time (not wall clock) for determinism
  #
  # Evidence Signal References (HARD CONTRACT - IDs-first, types-second):
  # - evidence_signals: Array of signal types (human-readable, for documentation only)
  # - Engine MUST resolve to actual signal_ids when storing in DDB read model
  # - Store as evidence_signal_ids[] (top K) for auditability and traceability
  # - Store as evidence_snapshot_refs[] (S3 URIs + SHA256) for immutable evidence linkage
  # - Multiple signals of same type: use latest active signal or all active signals
  # - IDs and snapshot refs are authoritative; types are for human readability only
  # - Violation: If engine stores only types without IDs, synthesis output is invalid
  
  # Severity Enums (normalized):
  # - risk_factors and opportunities use exactly: "low", "medium", "high"
  # - No other values allowed (no "critical", "urgent", etc.)
