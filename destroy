#!/bin/bash

set -e;

# Load environment variables from .env.local if it exists
if [ -f .env.local ]; then
  source .env.local
fi

# Parse arguments
# Use ADMIN_PROFILE for deployments if available (has CloudFormation permissions)
# Otherwise fall back to AWS_PROFILE
CDK_PROFILE=${ADMIN_PROFILE:-${AWS_PROFILE:-default}}
CDK_REGION=${AWS_REGION:-us-west-2}
while [[ "$#" -gt 0 ]]; do case $1 in
  --profile) CDK_PROFILE="$2"; shift;;
  --region) AWS_REGION="$2"; shift;;
  --force) FORCE_DESTROY=true;;
esac; shift; done

# Export CDK_DEFAULT_ACCOUNT from AWS_ACCOUNT_ID if set
# This ensures CDK uses the correct account ID from .env.local
if [ ! -z "$AWS_ACCOUNT_ID" ]; then
  export CDK_DEFAULT_ACCOUNT=$AWS_ACCOUNT_ID
  echo "Using Account ID from .env.local: $AWS_ACCOUNT_ID"
fi

# Export CDK_DEFAULT_REGION
export CDK_DEFAULT_REGION=$CDK_REGION

# Check if region is set
if [ -z "$AWS_REGION" ]; then
  # Try to get region from AWS config
  AWS_REGION=$(aws configure get region --profile $CDK_PROFILE 2>/dev/null)
  
  if [ -z "$AWS_REGION" ]; then
    echo "Error: AWS region is required"
    echo "Usage: ./destroy [--profile <aws_profile>] [--region <aws_region>] [--force]"
    echo "Example: ./destroy --profile dev --region us-west-2"
    echo "You may also configure your region by running 'aws configure'"
    exit 1
  fi
fi

echo "Using AWS Profile: $CDK_PROFILE"
echo "Using AWS Region: $AWS_REGION"

# Check if stack exists
STACK_NAME=$(aws cloudformation list-stacks \
  --profile $CDK_PROFILE \
  --region $AWS_REGION \
  --no-cli-pager \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE \
  --query "StackSummaries[?starts_with(StackName, 'CCNativeStack')].StackName" \
  --output text | head -n 1)

if [ -z "$STACK_NAME" ]; then
  echo "No CC Native stack found. Nothing to destroy."
  exit 0
fi

echo "Found stack: $STACK_NAME"

# Safety check
if [ "$FORCE_DESTROY" != "true" ]; then
  echo ""
  echo "⚠️  WARNING: This will destroy the CCNativeStack and all its resources!"
  echo "   This includes:"
  echo "   - All DynamoDB tables and data"
  echo "   - All S3 buckets and objects"
  echo "   - EventBridge bus and rules"
  echo "   - KMS keys"
  echo "   - All other stack resources"
  echo ""
  read -p "Are you sure you want to continue? (type 'yes' to confirm): " confirmation
  
  if [ "$confirmation" != "yes" ]; then
    echo "Destruction cancelled."
    exit 0
  fi
fi

echo ""
echo "Destroying stack: $STACK_NAME"
echo "This may take several minutes..."

# CDK context required so CCNativeStack constructor can load (same params as deploy)
# Use .env.local values when set; otherwise defaults so destroy works without full .env.local
BEDROCK_MODEL=${BEDROCK_MODEL:-anthropic.claude-3-5-sonnet-20240620-v1:0}
# Look up DynamoDB managed prefix list ID (ExecutionInfrastructure requires it)
DYNAMODB_PREFIX_LIST_ID=$(aws ec2 describe-managed-prefix-lists \
  --profile $CDK_PROFILE \
  --region $AWS_REGION \
  --no-cli-pager \
  --filters "Name=prefix-list-name,Values=com.amazonaws.$AWS_REGION.dynamodb" \
  --query 'PrefixLists[0].PrefixListId' \
  --output text) || DYNAMODB_PREFIX_LIST_ID=""
if [ -z "$DYNAMODB_PREFIX_LIST_ID" ]; then
  echo "Error: Could not look up DynamoDB prefix list for $AWS_REGION. Set dynamoDbPrefixListId in .env.local or run: aws ec2 describe-managed-prefix-lists --region $AWS_REGION --filters Name=prefix-list-name,Values=com.amazonaws.$AWS_REGION.dynamodb --query 'PrefixLists[0].PrefixListId' --output text"
  exit 1
fi
CDK_CONTEXT_PARAMS="-c bedrockModel=$BEDROCK_MODEL -c awsRegion=$AWS_REGION -c nodeEnv=development -c logLevel=info -c dynamoDbPrefixListId=$DYNAMODB_PREFIX_LIST_ID"

# Destroy the stack
# Use a different output directory to avoid conflicts with other CDK processes
npx cdk --profile $CDK_PROFILE --region $AWS_REGION destroy CCNativeStack --force --output cdk-destroy-out $CDK_CONTEXT_PARAMS

echo ""
echo "✅ Stack destruction complete!"
echo ""
echo "Note: Some resources may take time to fully delete:"
echo "   - S3 buckets with versioning may require manual cleanup"
echo "   - DynamoDB tables are deleted immediately"
echo "   - KMS keys may have deletion delays"
echo ""
